## MechOpt

Optimize reaction mechanism by automatic differentiation and gradient descent method.

### 1. Basic Theory

Given a model `η(θ)` that shows the mapping process from parameter `θ` to the target quantity of interest (QoI) `η`. We can define the loss function as:

L(θ) =  log²(η/η₀) + αθ²

where η₀ represents the ground truth QoI. Thus the gradient of loss function is

`grad` = ∂L/∂θ = 2 log(η/η₀) × ∂η/∂θ + 2αθ

Hence we can use `grad` to optimize our loss function to its minimum by gradient descent method like `SGD` or `ADAM`, which are famous gradient optimizer of neural networks.

Specifically, for ignition delay times (`IDTs`) or laminar flame speeds (`Sus`), we can obtain their gradient against the parameter as:

∂L/∂θ = 2 log(IDT/IDT₀) × ∂IDT/∂θ + 2αθ

∂L/∂θ = 2 log(Su/Su₀) × ∂Su/∂θ + 2αθ

Thus, we can employ the gradients to optimize kinetics parameters in chemical reaction mechanisms.

### 2. Mechanism files

The chemkin format usually contains
  + `chem.inp`, the elements, species and reactions, sometimes named as `mech.dat`
  + `therm.dat`, thermodynamics properties
  + `tran.dat`, tranportation properties

The input files cantera using is `cti` (2.4 and previous versions) and `yaml` (2.5 and later versions).

The `Arrhenius.jl` package reads cantera's `yaml` file and the `npz` file generated by script `interpreter.py`.

① Chemkin | ② Cantera | ③ Arrhenius.jl
     -- |    --   | --
mech.dat <br> therm.dat <br> trans.dat| mech.cit (version≤2.4) <br> mech.yaml (version≥2.5) | mech.yaml <br> mech.yaml.npz

① => ②: (get `mech.yaml`)
```
python -m cantera.ct2yaml --input mech.dat --thermo therm.dat --transport trans.dat
```

① <= ②: (get `gas.ck` which is equivalent to `mech.dat`)
```
python soln2ck.py -i mech.yaml
```

② => ③: (get `mech.yaml.npz`)
```
python interpreter.py -i mech.yaml
```

### 3. Code Implementation

```
MechOpt
+--- callback.jl                     ! [code] callback function, called in each epoch
+--- datasets_naturalgas.jl          ! [code] generate datasets for natural gas
+--- datasets_nc7h16.jl              ! [code] generate datasets for n-heptane
+--- header.jl                       ! [code] preparation for cases and folders
+--- input.yaml                      ! [input] global config file assigning case name
+--- LICENSE                         ! [text] license file
+--- main_opt_by_IDT&Su.jl           ! [code] optimization by IDT and/or Su
+--- main_valid_flame.jl             ! [code] validation by Su
+--- main_valid_IDT.jl               ! [code] validation by IDT
+--- main_valid_profiles.jl          ! [code] validation by IDT profiles
+--- sensitivity.jl                  ! [code] calculate sensitivities (gradients ∂η/∂θ)
+--- simulator.jl                    ! [code] simulate the reactors (0D ideal gas)
+--- visual.jl                       ! [code] visualization functions
+--- README.md                       ! [text] the explainations
+--- mechanism                       ! [folder] save for mechanism files
+--- results                         ! [folder] save for resutls
|   +--- gri30_sk23_op               ! [folder] case name is `gri30_sk23_op`
|   |   +--- checkpoint              ! [folder] save for models and calculations
|   |   |   +--- mymodel.bson        ! [bson] bson file saving for model status
|   |   +--- conds.bson              ! [bson] bson file saving for IDT data under conditions
|   |   +--- conds_f.bson            ! [bson] bson file saving for Su data under conditions
|   |   +--- config.yaml             ! [input] config file for current case
|   |   +--- figs                    ! [folder] save for resutls figures
|   |   |   +--- conditions          ! [folder] save for resutls profiles
|   |   |   +--- IDTs_phi=0.5.png    ! [image] IDT comparisons
|   |   |   +--- IDTs_phi=1.0.png    ! [image] IDT comparisons
|   |   |   +--- IDTs_phi=1.5.png    ! [image] IDT comparisons
|   |   |   +--- loss_grad.png       ! [image] loss, grad and p history
|   |   |   +--- regression.png      ! [image] IDT comparisons
|   |   |   +--- regression_f.png    ! [image] IDT comparisons
|   |   |   +--- Sus_compare.png     ! [image] Su comparisons
|   |   +--- IDTs_GRI30.bson         ! [bson] bson file saving for IDT validation conditions
|   |   +--- IDTs_SK23.bson          ! [bson] bson file saving for IDT validation conditions
|   |   +--- IDTs_SK23OP.bson        ! [bson] bson file saving for IDT validation conditions
|   |   +--- p.bson                  ! [bson] bson file saving for parameters
|   |   +--- Sus_GRI30.bson          ! [bson] bson file saving for Su validation conditions
|   |   +--- Sus_SK23.bson           ! [bson] bson file saving for Su validation conditions
|   |   +--- Sus_SK23OP.bson         ! [bson] bson file saving for Su validation conditions
+--- tools                           ! [folder] save for useful tools
```

### 4. References

+ For Neural Differential Equations
1. Weiqi Ji, Xingyu Su, et al. Arrhenius.jl: A differentiable Combustion Simulation Package.
2. Tianqi Chen, et al. Neural Oridinary Differential Equations.
3. Weiqi Ji, et al. Machine Learning Approaches to Learn HyChem Models.
4. Weiqi Ji et al. Autonomous Discovery of Unknown Reaction Pathways from Data by Chemical Reaction Neural Network.
5. Xingyu Su, Weiqi Ji, et al. Neural Differential Equations for Inverse Modeling in Model Combustor.

+ For sensitivity analysis
1. Weiqi Ji, et al. Evolution of sensitivity directions during autoignition.
2. Vyaas Gururajan, et al. Direct sensitivity analysis for ignition delay times. [sensBVP method]

+ For Uncertainty Analysis
1. Weiqi Ji et al. Quantifying kinetic uncertainty in turbulent combustion simulations using active subspaces.
2. Xingyu Su, Weiqi Ji, et al. Uncertainty Analysis in mechanism reduction via active subspace and transition state analysis.
3. Nana Wang, et al. Quantification of modeling uncertainties in turbulent flames through successive dimension reduction.
4. Yachao Chang, et al. Construction and assessment of reduced oxidation mechanisms using global sensitivity analysis and uncertainty analysis.
5. Hongxin Wang, et al. A comprehensive kinetic modeling study of ethylene combustion with data uncertainty analysis. [data uncertainty]
6. Liming Cai, et al. Optimized reaction mechanism rate rules for ignition of normal alkanes. [bayes optimization]

+ For n-heptane mechanisms
1. Keyvan Bahlouli, et al. A reduced mechanism for predicting the ignition timing of a fuel blend of natural-gas and n-heptane in HCCI engine. [EMU mechanisms]
2. Hanjun Xu, et al. Chemical kinetic mechanism and a skeletal model for oxidation of n-heptane/methanol fuel blends. [TU2011 mechanism]
3. M.S. Bernardi, et al. Curve matching, a generalized framework for models/experiments comparison: An application to n- heptane combustion kinetic mechanisms. [n-heptane data]
4. Lena Ruwe, et al. Low- and high-temperature study of n-heptane combustion chemistry. [n-heptane experiments]
5. Fadila Maroteaux, et al. N-heptane ignition delay time with temperature criterion for HCCI combustion. [n-heptane 7-steps and 26-steps]
6. Junjie Liang, et al. Experimental and kinetic studies of ignition processes of the methane–nheptane mixtures. [methane/n-heptane experiments]
